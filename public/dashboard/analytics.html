<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KLT2444N9N"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-KLT2444N9N');
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë°©ë¬¸í†µê³„ - KEAI</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="stylesheet" href="../css/dashboard.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .loading-skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .error-message {
      text-align: center;
      padding: 40px;
      color: var(--error);
    }
    .refresh-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: var(--neutral-100);
      border: none;
      border-radius: var(--radius-md);
      font-size: 13px;
      color: var(--neutral-700);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .refresh-btn:hover {
      background: var(--neutral-200);
    }
    .refresh-btn.loading svg {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    .data-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .data-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--neutral-100);
    }
    .data-list-item:last-child {
      border-bottom: none;
    }
    .data-list-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--neutral-700);
    }
    .data-list-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--neutral-800);
    }
    .data-list-badge {
      font-size: 12px;
      padding: 2px 8px;
      background: rgba(0, 102, 204, 0.1);
      color: var(--primary);
      border-radius: 10px;
      margin-left: 8px;
    }
    .progress-bar {
      height: 6px;
      background: var(--neutral-200);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 6px;
    }
    .progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }
    .last-updated {
      font-size: 12px;
      color: var(--neutral-500);
    }
    .section-divider {
      margin: 40px 0 24px;
      padding-top: 24px;
      border-top: 2px solid var(--neutral-200);
    }
    .table-empty {
      text-align: center;
      padding: 40px;
      color: var(--neutral-400);
    }
    .compare-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    @media (max-width: 768px) {
      .compare-grid {
        grid-template-columns: 1fr;
      }
    }
    .compare-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: 20px;
      border: 1px solid var(--neutral-200);
    }
    .compare-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--neutral-700);
      margin-bottom: 16px;
    }
    .compare-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--neutral-100);
    }
    .compare-row:last-child {
      border-bottom: none;
    }
    .compare-label {
      font-size: 13px;
      color: var(--neutral-600);
    }
    .compare-values {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .compare-current {
      font-size: 14px;
      font-weight: 600;
      color: var(--neutral-800);
    }
    .compare-change {
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .compare-change.positive {
      background: rgba(16, 185, 129, 0.1);
      color: #10B981;
    }
    .compare-change.negative {
      background: rgba(239, 68, 68, 0.1);
      color: #EF4444;
    }
    .cumulative-chart-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: 20px;
      border: 1px solid var(--neutral-200);
    }
    .cumulative-chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .cumulative-chart-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--neutral-800);
    }
    .history-table-wrapper {
      overflow-x: auto;
    }
    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .history-table th,
    .history-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--neutral-100);
    }
    .history-table th {
      background: var(--neutral-50);
      font-weight: 600;
      color: var(--neutral-700);
    }
    .history-table .table-value {
      font-weight: 600;
      color: var(--neutral-800);
    }
    .month-group-header {
      background: var(--neutral-50);
      cursor: pointer;
    }
    .month-group-header:hover {
      background: var(--neutral-100);
    }
    .month-group-header.current {
      background: rgba(0, 102, 204, 0.05);
    }
    .month-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .toggle-icon {
      font-size: 10px;
      color: var(--neutral-500);
    }
    .month-count {
      font-size: 11px;
      color: var(--neutral-500);
      font-weight: normal;
    }
    .month-detail-row {
      background: white;
    }
    .month-detail-row:hover {
      background: var(--neutral-50);
    }
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-top: 1px solid var(--neutral-100);
      margin-top: 8px;
    }
    .pagination-info {
      font-size: 13px;
      color: var(--neutral-500);
    }
    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .pagination-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      height: 32px;
      padding: 0 8px;
      border: 1px solid var(--neutral-200);
      background: white;
      border-radius: var(--radius-md);
      font-size: 13px;
      color: var(--neutral-600);
      cursor: pointer;
      transition: all 0.2s;
    }
    .pagination-btn:hover:not(:disabled) {
      border-color: var(--primary);
      color: var(--primary);
    }
    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .pagination-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .pagination-btn.nav-btn {
      padding: 0 14px;
      min-width: auto;
      white-space: nowrap;
      gap: 4px;
    }
    .page-size-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--neutral-600);
    }
    .page-size-selector select {
      padding: 6px 8px;
      border: 1px solid var(--neutral-200);
      border-radius: var(--radius-md);
      font-size: 13px;
      cursor: pointer;
    }
    @media (max-width: 768px) {
      .pagination-container {
        flex-direction: column;
        gap: 12px;
      }
      .pagination-info {
        order: 2;
      }
      .page-size-selector {
        order: 3;
      }
      .history-table-wrapper {
        overflow-x: visible;
      }
      .history-table {
        display: block;
      }
      .history-table thead {
        display: none;
      }
      .history-table tbody {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .history-table tr {
        display: block;
        background: white;
        border-radius: var(--radius-md);
        padding: 12px;
        border: 1px solid var(--neutral-200);
      }
      .history-table tr.month-group-header {
        background: var(--neutral-50);
        border-color: var(--neutral-300);
      }
      .history-table tr.month-group-header td {
        display: block;
        padding: 4px 0;
        border: none;
      }
      .history-table tr.month-group-header td:first-child {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 8px;
      }
      .history-table tr.month-detail-row td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid var(--neutral-100);
      }
      .history-table tr.month-detail-row td:last-child {
        border-bottom: none;
      }
      .history-table tr.month-detail-row td::before {
        content: attr(data-label);
        font-size: 12px;
        color: var(--neutral-500);
        font-weight: 500;
      }
      .history-table tr.month-detail-row td:first-child {
        font-weight: 600;
        color: var(--primary);
        justify-content: center;
        background: var(--neutral-50);
        margin: -12px -12px 8px -12px;
        padding: 10px 12px;
        border-radius: var(--radius-md) var(--radius-md) 0 0;
      }
      .history-table tr.month-detail-row td:first-child::before {
        display: none;
      }
      .month-toggle {
        flex-wrap: wrap;
      }
      .month-group-header td:not(:first-child) {
        font-size: 12px;
      }
    }
    .unified-filter-section {
      background: white;
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--neutral-200);
    }
    .filter-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .filter-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--neutral-800);
    }
    .filter-desc {
      font-size: 12px;
      color: var(--neutral-500);
    }
    .filter-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
    }
    .quick-period-btns {
      display: flex;
      gap: 6px;
    }
    .quick-btn {
      padding: 8px 14px;
      border: 1px solid var(--neutral-200);
      background: white;
      border-radius: var(--radius-md);
      font-size: 13px;
      color: var(--neutral-600);
      cursor: pointer;
      transition: all 0.2s;
    }
    .quick-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    .quick-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .date-range-inputs {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .date-label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
      color: var(--neutral-500);
    }
    .date-input {
      padding: 8px 12px;
      border: 1px solid var(--neutral-200);
      border-radius: var(--radius-md);
      font-size: 13px;
      color: var(--neutral-700);
    }
    .date-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .date-separator {
      color: var(--neutral-400);
      padding-top: 16px;
    }
    .apply-btn {
      padding: 8px 16px;
      background: var(--primary);
      border: none;
      border-radius: var(--radius-md);
      font-size: 13px;
      color: white;
      cursor: pointer;
      margin-top: 16px;
      transition: background 0.2s;
    }
    .apply-btn:hover {
      background: var(--primary-hover, #0052A3);
    }
    .current-period-display {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--neutral-100);
    }
    .period-icon {
      font-size: 16px;
    }
    .period-text {
      font-size: 14px;
      color: var(--neutral-700);
      font-weight: 500;
    }
    @media (max-width: 768px) {
      .filter-controls {
        flex-direction: column;
        align-items: stretch;
      }
      .quick-period-btns {
        flex-wrap: wrap;
      }
      .date-range-inputs {
        flex-wrap: wrap;
      }
    }
    .analysis-summary {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-top: 24px;
      border: 1px solid var(--neutral-200);
    }
    .analysis-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    .analysis-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--neutral-800);
    }
    .analysis-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }
    .analysis-item {
      background: white;
      border-radius: var(--radius-md);
      padding: 16px;
      border-left: 4px solid var(--primary);
    }
    .analysis-item.positive {
      border-left-color: #10B981;
    }
    .analysis-item.negative {
      border-left-color: #EF4444;
    }
    .analysis-item.neutral {
      border-left-color: #F59E0B;
    }
    .analysis-label {
      font-size: 12px;
      color: var(--neutral-500);
      margin-bottom: 4px;
    }
    .analysis-text {
      font-size: 14px;
      color: var(--neutral-700);
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ (ëª¨ë°”ì¼) -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="sidebar"></aside>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="main-content">
      <!-- í—¤ë” -->
      <header class="dashboard-header"></header>

      <!-- í†µí•© ê¸°ê°„ í•„í„° -->
      <div class="unified-filter-section">
        <div class="filter-header">
          <span class="filter-title">ğŸ“… ì¡°íšŒ ê¸°ê°„ ì„¤ì •</span>
          <span class="filter-desc">ì„¤ì •í•œ ê¸°ê°„ì´ ëª¨ë“  í†µê³„ì— ì ìš©ë©ë‹ˆë‹¤</span>
        </div>
        <div class="filter-controls">
          <div class="quick-period-btns">
            <button class="quick-btn" data-days="1">ì˜¤ëŠ˜</button>
            <button class="quick-btn active" data-days="7">7ì¼</button>
            <button class="quick-btn" data-days="14">14ì¼</button>
            <button class="quick-btn" data-days="30">30ì¼</button>
            <button class="quick-btn" data-days="90">90ì¼</button>
          </div>
          <div class="date-range-inputs">
            <label class="date-label">
              ì‹œì‘ì¼
              <input type="date" id="startDate" class="date-input">
            </label>
            <span class="date-separator">~</span>
            <label class="date-label">
              ì¢…ë£Œì¼
              <input type="date" id="endDate" class="date-input">
            </label>
            <button class="apply-btn" onclick="applyDateFilter()">ì ìš©</button>
          </div>
          <button class="refresh-btn" onclick="refreshData()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 4v6h-6M1 20v-6h6"/>
              <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
            </svg>
            ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
        <div class="current-period-display">
          <span class="period-icon">ğŸ“Š</span>
          <span class="period-text" id="period-display">ë¡œë”© ì¤‘...</span>
        </div>
      </div>

      <!-- í†µê³„ ì¹´ë“œ -->
      <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
          </div>
          <div class="stat-content">
            <p class="stat-label">ë°©ë¬¸ì</p>
            <p class="stat-value" id="stat-visitors">-</p>
            <p class="stat-change" id="stat-visitors-change">ë¡œë”© ì¤‘...</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon icon-page">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14,2 14,8 20,8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
          </div>
          <div class="stat-content">
            <p class="stat-label">í˜ì´ì§€ë·°</p>
            <p class="stat-value" id="stat-pageviews">-</p>
            <p class="stat-change" id="stat-pageviews-change">ë¡œë”© ì¤‘...</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon icon-time">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12,6 12,12 16,14"/>
            </svg>
          </div>
          <div class="stat-content">
            <p class="stat-label">í‰ê·  ì²´ë¥˜ì‹œê°„</p>
            <p class="stat-value" id="stat-duration">-</p>
            <p class="stat-change" id="stat-duration-change">ë¡œë”© ì¤‘...</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon icon-inbox">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
              <polyline points="16,17 21,12 16,7"/>
              <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
          </div>
          <div class="stat-content">
            <p class="stat-label">ì´íƒˆë¥ </p>
            <p class="stat-value" id="stat-bounce">-</p>
            <p class="stat-change" id="stat-bounce-change">ë¡œë”© ì¤‘...</p>
          </div>
        </div>
      </div>

      <!-- ì¶”ì´ ì°¨íŠ¸ -->
      <div class="charts-grid analytics-charts">
        <div class="chart-card chart-card-wide">
          <div class="chart-header">
            <h3 class="chart-title" id="chart-title">ì¼ë³„ ë°©ë¬¸ ì¶”ì´ (ìµœê·¼ 7ì¼)</h3>
            <div class="chart-legend">
              <div class="legend-item"><span class="legend-color" style="background:#0066CC"></span>ë°©ë¬¸ì</div>
              <div class="legend-item"><span class="legend-color" style="background:#10B981"></span>í˜ì´ì§€ë·°</div>
            </div>
          </div>
          <div class="chart-body" style="height:200px">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
      </div>

      <!-- ë¶„ì„ ê·¸ë¦¬ë“œ -->
      <div class="charts-grid" style="margin-top:20px">
        <!-- íŠ¸ë˜í”½ ì†ŒìŠ¤ -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">ğŸ”— íŠ¸ë˜í”½ ì†ŒìŠ¤</h3>
          </div>
          <ul class="data-list" id="traffic-list">
            <li class="data-list-item">
              <span class="data-list-label loading-skeleton" style="width:100px;height:16px"></span>
              <span class="data-list-value loading-skeleton" style="width:50px;height:16px"></span>
            </li>
          </ul>
        </div>

        <!-- ìœ ì… ê²½ë¡œ (ì°¸ì¡° URL) -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">ğŸŒ ìœ ì… ê²½ë¡œ</h3>
          </div>
          <ul class="data-list" id="referrer-list">
            <li class="data-list-item">
              <span class="data-list-label loading-skeleton" style="width:150px;height:16px"></span>
              <span class="data-list-value loading-skeleton" style="width:40px;height:16px"></span>
            </li>
          </ul>
        </div>

        <!-- ê¸°ê¸°ë³„ -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">ğŸ“± ê¸°ê¸°ë³„ ì‚¬ìš©ì</h3>
          </div>
          <ul class="data-list" id="devices-list">
            <li class="data-list-item">
              <span class="data-list-label loading-skeleton" style="width:100px;height:16px"></span>
              <span class="data-list-value loading-skeleton" style="width:50px;height:16px"></span>
            </li>
          </ul>
        </div>

        <!-- ì¸ê¸° í˜ì´ì§€ -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">ğŸ“„ ì¸ê¸° í˜ì´ì§€</h3>
          </div>
          <ul class="data-list" id="pages-list">
            <li class="data-list-item">
              <span class="data-list-label loading-skeleton" style="width:150px;height:16px"></span>
              <span class="data-list-value loading-skeleton" style="width:40px;height:16px"></span>
            </li>
          </ul>
        </div>

        <!-- ì§€ì—­ë³„ -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">ğŸŒ ë°©ë¬¸ ì§€ì—­</h3>
          </div>
          <ul class="data-list" id="geography-list">
            <li class="data-list-item">
              <span class="data-list-label loading-skeleton" style="width:80px;height:16px"></span>
              <span class="data-list-value loading-skeleton" style="width:40px;height:16px"></span>
            </li>
          </ul>
        </div>
      </div>

      <!-- ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ -->
      <div style="text-align:center; margin-top:24px; padding:16px;">
        <span class="last-updated" id="last-updated"></span>
      </div>

      <!-- ========== íˆìŠ¤í† ë¦¬ ì„¹ì…˜ ========== -->
      <div class="section-divider" style="margin-bottom: 100px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <h2 class="section-title" style="margin:0;">ğŸ“Š ê¸°ê°„ë³„ ëˆ„ì  ë°ì´í„°</h2>
          <span class="filter-sync-badge" style="font-size:12px; color:var(--primary); background:rgba(0,102,204,0.1); padding:4px 10px; border-radius:12px;">
            â¬† ìƒë‹¨ í•„í„°ì™€ ì—°ë™ë¨
          </span>
        </div>

        <!-- ê¸°ê°„ ë¹„êµ (ì¼ê°„/ì£¼ê°„/ì›”ê°„ í•œëˆˆì—) -->
        <div class="compare-grid" id="compare-grid">
          <div class="compare-card">
            <div class="compare-title">ğŸ“… ì˜¤ëŠ˜ vs ì–´ì œ</div>
            <div id="compare-daily">
              <div class="compare-row">
                <span class="compare-label">ë°©ë¬¸ì</span>
                <div class="compare-values">
                  <span class="compare-current loading-skeleton" style="width:40px;height:16px"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="compare-card">
            <div class="compare-title">ğŸ“† ì´ë²ˆ ì£¼ vs ì§€ë‚œ ì£¼</div>
            <div id="compare-weekly">
              <div class="compare-row">
                <span class="compare-label">ë°©ë¬¸ì</span>
                <div class="compare-values">
                  <span class="compare-current loading-skeleton" style="width:40px;height:16px"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="compare-card">
            <div class="compare-title">ğŸ—“ï¸ ì´ë²ˆ ë‹¬ vs ì§€ë‚œ ë‹¬</div>
            <div id="compare-monthly">
              <div class="compare-row">
                <span class="compare-label">ë°©ë¬¸ì</span>
                <div class="compare-values">
                  <span class="compare-current loading-skeleton" style="width:40px;height:16px"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ëˆ„ì  ì¶”ì´ ì°¨íŠ¸ -->
        <div class="cumulative-chart-card">
          <div class="cumulative-chart-header">
            <span class="cumulative-chart-title">ğŸ“ˆ ì¥ê¸° ì¶”ì´ ì°¨íŠ¸</span>
            <span style="font-size:11px; color:var(--neutral-400)">ë§¤ì¼ 01:00 ìë™ ìˆ˜ì§‘</span>
          </div>
          <div style="height:250px">
            <canvas id="historyChart"></canvas>
          </div>
        </div>

        <!-- íˆìŠ¤í† ë¦¬ í…Œì´ë¸” -->
        <div class="cumulative-chart-card" style="margin-top:16px">
          <div class="cumulative-chart-header" style="display:flex; justify-content:space-between; align-items:center;">
            <span class="cumulative-chart-title">ğŸ“‹ ì¼ë³„ ìƒì„¸ ë°ì´í„°</span>
            <span id="lastSyncTime" style="font-size:12px; color:var(--neutral-500);">ë§ˆì§€ë§‰ ìˆ˜ì§‘: -</span>
          </div>
          <div class="history-table-wrapper">
            <table class="history-table">
              <thead>
                <tr>
                  <th>ë‚ ì§œ</th>
                  <th>ë°©ë¬¸ì</th>
                  <th>í˜ì´ì§€ë·°</th>
                  <th>í‰ê·  ì²´ë¥˜</th>
                  <th>ì´íƒˆë¥ </th>
                </tr>
              </thead>
              <tbody id="history-table-body">
                <tr>
                  <td colspan="5" class="table-empty">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
          <div class="pagination-container" id="history-pagination">
            <div class="pagination-info" id="pagination-info">
              ì´ 0ê°œ ì¤‘ 0-0
            </div>
            <div class="pagination-controls" id="pagination-controls">
              <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
            <div class="page-size-selector">
              <span>í˜ì´ì§€ë‹¹</span>
              <select id="page-size-select" onchange="changePageSize(this.value)">
                <option value="10">10ê°œ</option>
                <option value="20" selected>20ê°œ</option>
                <option value="50">50ê°œ</option>
                <option value="100">100ê°œ</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ê¸°ê°„ ë¶„ì„ í‰ê°€ -->
        <div class="analysis-summary" id="analysis-summary">
          <div class="analysis-header">
            <span>ğŸ’¡</span>
            <span class="analysis-title">ê¸°ê°„ ë¶„ì„ í‰ê°€</span>
          </div>
          <div class="analysis-content" id="analysis-content">
            <div class="analysis-item">
              <div class="analysis-label">ë¶„ì„ ì¤‘...</div>
              <div class="analysis-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.</div>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- í•˜ë‹¨ ë©”ë‰´ë°” (ëª¨ë°”ì¼) -->
  <nav class="bottom-nav"></nav>

  <script src="../js/config.js"></script>
  <script src="../js/components.js"></script>
  <script>
    // ============================================================
    // KEAI Analytics - KPFC ìŠ¤íƒ€ì¼ ì ìš©
    // API ì—”ë“œí¬ì¸íŠ¸: /api/analytics (Airtable ìºì‹œ)
    // ============================================================
    const ANALYTICS_API_URL = '/api/analytics';

    // í†µí•© í•„í„° ìƒíƒœ
    let filterDays = 7;
    let filterStartDate = null;
    let filterEndDate = null;
    let trendChart = null;
    let historyChart = null;
    let analyticsData = null;

    // í˜ì´ì§€ë„¤ì´ì…˜ ìƒíƒœ
    let currentPage = 1;
    let pageSize = 20;
    let allHistoryData = [];

    // ì‚¬ì´ë“œë°” í† ê¸€
    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('open');
      document.querySelector('.sidebar-overlay').classList.toggle('open');
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      // KEAI ì»´í¬ë„ŒíŠ¸ ë¡œë“œ
      loadSidebar('analytics');
      loadDashboardHeader('ë°©ë¬¸í†µê³„', 'Google Analytics ë°ì´í„°');
      loadMobileBottomNav('analytics');

      initUnifiedFilter();
      initDateInputs();
      loadAllDataWithFilter();
    });

    // í†µí•© í•„í„° ì´ˆê¸°í™”
    function initUnifiedFilter() {
      const quickBtns = document.querySelectorAll('.quick-btn');
      quickBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          quickBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          filterDays = parseInt(this.dataset.days);

          // ë‚ ì§œ ì…ë ¥ ì´ˆê¸°í™”
          filterStartDate = null;
          filterEndDate = null;
          document.getElementById('startDate').value = '';
          document.getElementById('endDate').value = '';

          // ëª¨ë“  ë°ì´í„° ìƒˆë¡œê³ ì¹¨
          loadAllDataWithFilter();
        });
      });
    }

    // ë‚ ì§œ ì…ë ¥ ì´ˆê¸°í™”
    function initDateInputs() {
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];

      document.getElementById('startDate').max = todayStr;
      document.getElementById('endDate').max = todayStr;
    }

    // ë‚ ì§œ í•„í„° ì ìš©
    function applyDateFilter() {
      const startInput = document.getElementById('startDate').value;
      const endInput = document.getElementById('endDate').value;

      if (!startInput || !endInput) {
        alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (startInput > endInput) {
        alert('ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      filterStartDate = startInput;
      filterEndDate = endInput;

      // ë¹ ë¥¸ ì„ íƒ ë²„íŠ¼ ë¹„í™œì„±í™”
      document.querySelectorAll('.quick-btn').forEach(b => b.classList.remove('active'));

      // ì¼ìˆ˜ ê³„ì‚°
      const start = new Date(startInput);
      const end = new Date(endInput);
      filterDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

      loadAllDataWithFilter();
    }

    // ëª¨ë“  ë°ì´í„°ë¥¼ í•„í„°ì— ë§ì¶° ë¡œë“œ
    async function loadAllDataWithFilter() {
      updatePeriodDisplay();

      try {
        await loadAnalyticsData();
      } catch (e) {
        console.error('Analytics load error:', e);
      }

      try {
        loadCompareData();
      } catch (e) {
        console.error('Compare load error:', e);
      }
    }

    // ê¸°ê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updatePeriodDisplay() {
      const today = new Date();
      let startDate, endDate;

      if (filterStartDate && filterEndDate) {
        startDate = filterStartDate;
        endDate = filterEndDate;
      } else {
        endDate = today.toISOString().split('T')[0];
        const start = new Date(today);
        start.setDate(today.getDate() - filterDays + 1);
        startDate = start.toISOString().split('T')[0];
      }

      const formatKorDate = (dateStr) => {
        const [y, m, d] = dateStr.split('-');
        return `${y}.${m}.${d}`;
      };

      const displayText = filterDays === 1
        ? `${formatKorDate(endDate)} (ì˜¤ëŠ˜)`
        : `${formatKorDate(startDate)} ~ ${formatKorDate(endDate)} (${filterDays}ì¼ê°„)`;

      document.getElementById('period-display').textContent = displayText;
    }

    // ë¶„ì„ ë°ì´í„° ë¡œë“œ
    async function loadAnalyticsData() {
      try {
        showLoading();

        const response = await fetch(`${ANALYTICS_API_URL}?days=${filterDays}`);
        if (!response.ok) throw new Error('API ìš”ì²­ ì‹¤íŒ¨');

        const result = await response.json();
        analyticsData = result.data || [];

        // ë‚ ì§œ ë²”ìœ„ í•„í„°ë§
        let filteredData = analyticsData;
        if (filterStartDate && filterEndDate) {
          filteredData = analyticsData.filter(d =>
            d.date >= filterStartDate && d.date <= filterEndDate
          );
        }

        renderDashboard(filteredData);
        renderHistoryTable(filteredData);
        renderHistoryChart(filteredData);
        updateLastSyncTime(filteredData);
        generateAnalysisSummary(filteredData);

      } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    }

    // ëŒ€ì‹œë³´ë“œ ë Œë”ë§
    function renderDashboard(data) {
      if (!data || data.length === 0) {
        showError('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ì •ë ¬ (ìµœì‹ ìˆœ)
      const sortedData = [...data].sort((a, b) => b.date.localeCompare(a.date));
      const latest = sortedData[0] || {};
      const prev = sortedData[1] || {};

      // í•©ê³„ ê³„ì‚°
      const totalVisitors = data.reduce((sum, d) => sum + (d.visitors || 0), 0);
      const totalPageviews = data.reduce((sum, d) => sum + (d.pageviews || 0), 0);
      const avgDuration = data.reduce((sum, d) => sum + (d.avg_duration || 0), 0) / data.length;
      const avgBounce = data.reduce((sum, d) => sum + (d.bounce_rate || 0), 0) / data.length;

      // í†µê³„ ì¹´ë“œ
      document.getElementById('stat-visitors').textContent = totalVisitors.toLocaleString() + 'ëª…';
      document.getElementById('stat-pageviews').textContent = totalPageviews.toLocaleString() + 'íšŒ';
      document.getElementById('stat-duration').textContent = formatDuration(avgDuration);
      document.getElementById('stat-bounce').textContent = Math.round(avgBounce * 100) + '%';

      // ë³€í™”ìœ¨ (ìµœê·¼ vs ì´ì „)
      renderChange('stat-visitors-change', latest.visitors, prev.visitors);
      renderChange('stat-pageviews-change', latest.pageviews, prev.pageviews);
      renderChange('stat-duration-change', latest.avg_duration, prev.avg_duration);
      renderChange('stat-bounce-change', latest.bounce_rate, prev.bounce_rate, true);

      // ì°¨íŠ¸
      renderTrendChart(data);

      // ì¶”ê°€ í†µê³„
      renderTrafficSources(latest);
      renderDevices(latest);
      renderTopPages(latest);
      renderGeography(latest);
      renderReferrers(latest);

      // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸
      document.getElementById('last-updated').textContent =
        `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')}`;
    }

    // ë³€í™”ìœ¨ í‘œì‹œ
    function renderChange(elementId, current, previous, isReverse = false) {
      const el = document.getElementById(elementId);
      current = current || 0;
      previous = previous || 0;

      const change = previous > 0 ? Math.round(((current - previous) / previous) * 100) : 0;
      const isPositive = isReverse ? change < 0 : change > 0;
      const sign = change >= 0 ? '+' : '';

      el.textContent = `${sign}${change}% ì „ì¼ ëŒ€ë¹„`;
      el.className = `stat-change ${isPositive ? 'positive' : 'negative'}`;
    }

    // ì¶”ì´ ì°¨íŠ¸
    function renderTrendChart(data) {
      const ctx = document.getElementById('trendChart').getContext('2d');

      let chartTitle = 'ì¼ë³„ ë°©ë¬¸ ì¶”ì´';
      if (filterDays === 1) chartTitle = 'ì˜¤ëŠ˜ ë°©ë¬¸ ì¶”ì´';
      else if (filterDays <= 7) chartTitle = `ì¼ë³„ ë°©ë¬¸ ì¶”ì´ (${filterDays}ì¼)`;
      else chartTitle = `ì¥ê¸° ë°©ë¬¸ ì¶”ì´ (${filterDays}ì¼)`;
      document.getElementById('chart-title').textContent = chartTitle;

      if (trendChart) trendChart.destroy();

      const sortedData = [...data].sort((a, b) => a.date.localeCompare(b.date));
      const labels = sortedData.map(d => formatChartDate(d.date));
      const visitors = sortedData.map(d => d.visitors || 0);
      const pageviews = sortedData.map(d => d.pageviews || 0);

      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'ë°©ë¬¸ì',
              data: visitors,
              borderColor: '#0066CC',
              backgroundColor: 'rgba(0, 102, 204, 0.1)',
              fill: true,
              tension: 0.4,
              borderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6
            },
            {
              label: 'í˜ì´ì§€ë·°',
              data: pageviews,
              borderColor: '#10B981',
              backgroundColor: 'transparent',
              tension: 0.4,
              borderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'white',
              titleColor: '#1F2937',
              bodyColor: '#4B5563',
              borderColor: '#E5E7EB',
              borderWidth: 1,
              padding: 12
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { font: { size: 11 } }
            },
            y: {
              beginAtZero: true,
              grid: { color: '#F3F4F6' },
              ticks: { font: { size: 11 } }
            }
          }
        }
      });
    }

    // íŠ¸ë˜í”½ ì†ŒìŠ¤
    function renderTrafficSources(data) {
      const list = document.getElementById('traffic-list');
      const sources = [
        { name: 'ê²€ìƒ‰ ìœ ì…', value: data.sourceOrganic || 0, color: '#10B981' },
        { name: 'ì§ì ‘ ë°©ë¬¸', value: data.sourceDirect || 0, color: '#0066CC' },
        { name: 'ì°¸ì¡° ìœ ì…', value: data.sourceReferral || 0, color: '#F59E0B' },
        { name: 'ì†Œì…œ ë¯¸ë””ì–´', value: data.sourceSocial || 0, color: '#8B5CF6' },
        { name: 'ìœ ë£Œ ê´‘ê³ ', value: data.sourcePaid || 0, color: '#EC4899' },
        { name: 'ê¸°íƒ€', value: data.sourceOther || 0, color: '#6B7280' }
      ];

      const total = sources.reduce((sum, s) => sum + s.value, 0) || 1;

      list.innerHTML = sources.filter(s => s.value > 0).map(source => {
        const pct = Math.round((source.value / total) * 100);
        return `
          <li class="data-list-item">
            <div style="flex:1">
              <div class="data-list-label">
                <span style="width:8px;height:8px;background:${source.color};border-radius:2px"></span>
                ${source.name}
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width:${pct}%;background:${source.color}"></div>
              </div>
            </div>
            <span class="data-list-value">${source.value}íšŒ<span class="data-list-badge">${pct}%</span></span>
          </li>
        `;
      }).join('') || '<li class="data-list-item"><span class="data-list-label">ë°ì´í„° ì—†ìŒ</span></li>';
    }

    // ê¸°ê¸°ë³„
    function renderDevices(data) {
      const list = document.getElementById('devices-list');
      const devices = [
        { name: 'ë°ìŠ¤í¬í†±', value: data.deviceDesktop || 0, icon: 'ğŸ’»', color: '#10B981' },
        { name: 'ëª¨ë°”ì¼', value: data.deviceMobile || 0, icon: 'ğŸ“±', color: '#0066CC' },
        { name: 'íƒœë¸”ë¦¿', value: data.deviceTablet || 0, icon: 'ğŸ“²', color: '#F59E0B' }
      ];

      const total = devices.reduce((sum, d) => sum + d.value, 0) || 1;

      list.innerHTML = devices.filter(d => d.value > 0).map(device => {
        const pct = Math.round((device.value / total) * 100);
        return `
          <li class="data-list-item">
            <div style="flex:1">
              <div class="data-list-label">${device.icon} ${device.name}</div>
              <div class="progress-bar">
                <div class="progress-fill" style="width:${pct}%;background:${device.color}"></div>
              </div>
            </div>
            <span class="data-list-value">${device.value}ëª…<span class="data-list-badge">${pct}%</span></span>
          </li>
        `;
      }).join('') || '<li class="data-list-item"><span class="data-list-label">ë°ì´í„° ì—†ìŒ</span></li>';
    }

    // ì¸ê¸° í˜ì´ì§€
    function renderTopPages(data) {
      const list = document.getElementById('pages-list');
      let pages = [];
      try {
        pages = JSON.parse(data.topPages || '[]');
      } catch (e) {}

      if (!pages.length) {
        list.innerHTML = '<li class="data-list-item"><span class="data-list-label">ë°ì´í„° ì—†ìŒ</span></li>';
        return;
      }

      list.innerHTML = pages.slice(0, 5).map((page, idx) => `
        <li class="data-list-item">
          <span class="data-list-label">
            <span style="width:20px;height:20px;background:var(--primary);color:white;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:600">${idx + 1}</span>
            ${translatePage(page.path)}
          </span>
          <span class="data-list-value">${page.views}íšŒ</span>
        </li>
      `).join('');
    }

    // ë°©ë¬¸ ì§€ì—­
    function renderGeography(data) {
      const list = document.getElementById('geography-list');
      let countries = [];
      try {
        countries = JSON.parse(data.topCountries || '[]');
      } catch (e) {}

      if (!countries.length) {
        list.innerHTML = '<li class="data-list-item"><span class="data-list-label">ë°ì´í„° ì—†ìŒ</span></li>';
        return;
      }

      list.innerHTML = countries.slice(0, 5).map(c => `
        <li class="data-list-item">
          <span class="data-list-label">ğŸ“ ${c.country === 'KR' ? 'ëŒ€í•œë¯¼êµ­' : c.country}</span>
          <span class="data-list-value">${c.users}ëª…</span>
        </li>
      `).join('');
    }

    // ìœ ì… ê²½ë¡œ
    function renderReferrers(data) {
      const list = document.getElementById('referrer-list');
      let referrers = [];
      try {
        referrers = JSON.parse(data.topReferrers || '[]');
      } catch (e) {}

      if (!referrers.length) {
        list.innerHTML = '<li class="data-list-item"><span class="data-list-label">ìƒì„¸ ìœ ì… ê²½ë¡œëŠ” íŠ¸ë˜í”½ ì†ŒìŠ¤ì—ì„œ í™•ì¸í•˜ì„¸ìš”</span></li>';
        return;
      }

      list.innerHTML = referrers.slice(0, 5).map(ref => `
        <li class="data-list-item">
          <span class="data-list-label">ğŸ”— ${ref.source}</span>
          <span class="data-list-value">${ref.sessions}íšŒ</span>
        </li>
      `).join('');
    }

    // ë¹„êµ ë°ì´í„° ë¡œë“œ
    function loadCompareData() {
      const data = analyticsData || [];
      if (data.length < 2) return;

      const sortedData = [...data].sort((a, b) => b.date.localeCompare(a.date));

      // ì¼ê°„ ë¹„êµ
      const daily = calculateCompare(sortedData, 0, 1);
      renderCompareCard('compare-daily', daily);

      // ì£¼ê°„ ë¹„êµ
      const weekly = calculateWeeklyCompare(sortedData);
      renderCompareCard('compare-weekly', weekly);

      // ì›”ê°„ ë¹„êµ
      const monthly = calculateMonthlyCompare(sortedData);
      renderCompareCard('compare-monthly', monthly);
    }

    // ë‹¨ìˆœ ë¹„êµ ê³„ì‚°
    function calculateCompare(data, currentIdx, prevIdx) {
      const current = data[currentIdx] || { visitors: 0, pageviews: 0, avg_duration: 0, bounce_rate: 0 };
      const prev = data[prevIdx] || current;

      const calcChange = (curr, prv) => {
        if (prv === 0) return curr > 0 ? 100 : 0;
        return Math.round(((curr - prv) / prv) * 100);
      };

      return {
        visitors: { value: current.visitors || 0, change: calcChange(current.visitors, prev.visitors) },
        pageviews: { value: current.pageviews || 0, change: calcChange(current.pageviews, prev.pageviews) },
        duration: { value: formatDuration(current.avg_duration || 0), change: calcChange(current.avg_duration, prev.avg_duration) },
        bounceRate: { value: Math.round((current.bounce_rate || 0) * 100), change: calcChange(current.bounce_rate, prev.bounce_rate) }
      };
    }

    // ì£¼ê°„ ë¹„êµ
    function calculateWeeklyCompare(data) {
      const sum = (arr) => arr.reduce((acc, d) => ({
        visitors: acc.visitors + (d.visitors || 0),
        pageviews: acc.pageviews + (d.pageviews || 0),
        avg_duration: acc.avg_duration + (d.avg_duration || 0),
        bounce_rate: acc.bounce_rate + (d.bounce_rate || 0)
      }), { visitors: 0, pageviews: 0, avg_duration: 0, bounce_rate: 0 });

      const current = sum(data.slice(0, 7));
      const prev = sum(data.slice(7, 14));

      const count1 = Math.min(data.length, 7) || 1;
      const count2 = Math.min(Math.max(data.length - 7, 0), 7) || 1;
      current.avg_duration /= count1;
      current.bounce_rate /= count1;
      prev.avg_duration /= count2;
      prev.bounce_rate /= count2;

      return calculateCompare([current, prev], 0, 1);
    }

    // ì›”ê°„ ë¹„êµ
    function calculateMonthlyCompare(data) {
      const sum = (arr) => arr.reduce((acc, d) => ({
        visitors: acc.visitors + (d.visitors || 0),
        pageviews: acc.pageviews + (d.pageviews || 0),
        avg_duration: acc.avg_duration + (d.avg_duration || 0),
        bounce_rate: acc.bounce_rate + (d.bounce_rate || 0)
      }), { visitors: 0, pageviews: 0, avg_duration: 0, bounce_rate: 0 });

      const current = sum(data.slice(0, 30));
      const prev = sum(data.slice(30, 60));

      const count1 = Math.min(data.length, 30) || 1;
      const count2 = Math.min(Math.max(data.length - 30, 0), 30) || 1;
      current.avg_duration /= count1;
      current.bounce_rate /= count1;
      prev.avg_duration /= count2;
      prev.bounce_rate /= count2;

      return calculateCompare([current, prev], 0, 1);
    }

    // ë¹„êµ ì¹´ë“œ ë Œë”ë§
    function renderCompareCard(elementId, data) {
      const el = document.getElementById(elementId);
      if (!data) {
        el.innerHTML = '<div class="compare-row"><span class="compare-label">ë°ì´í„° ì—†ìŒ</span></div>';
        return;
      }

      const rows = [
        { label: 'ë°©ë¬¸ì', current: data.visitors.value, change: data.visitors.change, unit: 'ëª…' },
        { label: 'í˜ì´ì§€ë·°', current: data.pageviews.value, change: data.pageviews.change, unit: 'íšŒ' },
        { label: 'ì²´ë¥˜ì‹œê°„', current: data.duration.value, change: data.duration.change, unit: '' },
        { label: 'ì´íƒˆë¥ ', current: data.bounceRate.value + '%', change: data.bounceRate.change, unit: '', reverse: true }
      ];

      el.innerHTML = rows.map(row => {
        const isPositive = row.reverse ? row.change < 0 : row.change > 0;
        const changeClass = isPositive ? 'positive' : 'negative';
        const sign = row.change >= 0 ? '+' : '';
        return `
          <div class="compare-row">
            <span class="compare-label">${row.label}</span>
            <div class="compare-values">
              <span class="compare-current">${typeof row.current === 'number' ? row.current.toLocaleString() : row.current}${row.unit}</span>
              <span class="compare-change ${changeClass}">${sign}${row.change}%</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // íˆìŠ¤í† ë¦¬ í…Œì´ë¸”
    function renderHistoryTable(data) {
      allHistoryData = data || [];

      const tbody = document.getElementById('history-table-body');
      const paginationContainer = document.getElementById('history-pagination');

      if (!allHistoryData.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="table-empty">ì €ì¥ëœ íˆìŠ¤í† ë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        paginationContainer.style.display = 'none';
        return;
      }

      paginationContainer.style.display = 'flex';

      const sortedData = [...allHistoryData].sort((a, b) => b.date.localeCompare(a.date));
      const totalItems = sortedData.length;
      const totalPages = Math.ceil(totalItems / pageSize);

      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;

      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, totalItems);
      const pageData = sortedData.slice(startIndex, endIndex);

      // ì›”ë³„ ê·¸ë£¹í™”
      const groupedByMonth = {};
      pageData.forEach(row => {
        const monthKey = row.date.substring(0, 7);
        if (!groupedByMonth[monthKey]) groupedByMonth[monthKey] = [];
        groupedByMonth[monthKey].push(row);
      });

      const monthKeys = Object.keys(groupedByMonth).sort((a, b) => b.localeCompare(a));
      const currentMonth = new Date().toISOString().substring(0, 7);

      let html = '';
      monthKeys.forEach((monthKey, idx) => {
        const monthData = groupedByMonth[monthKey];
        const isCurrentMonth = monthKey === currentMonth;

        const totalVisitors = monthData.reduce((sum, r) => sum + (r.visitors || 0), 0);
        const totalPageviews = monthData.reduce((sum, r) => sum + (r.pageviews || 0), 0);
        const avgDuration = monthData.reduce((sum, r) => sum + (r.avg_duration || 0), 0) / monthData.length;
        const avgBounce = monthData.reduce((sum, r) => sum + (r.bounce_rate || 0), 0) / monthData.length;

        const [year, month] = monthKey.split('-');
        const monthLabel = `${year}ë…„ ${parseInt(month)}ì›”`;

        html += `
          <tr class="month-group-header ${isCurrentMonth ? 'current' : ''}" data-month="${monthKey}" onclick="toggleMonthGroup('${monthKey}')">
            <td data-label="">
              <div class="month-toggle">
                <span class="toggle-icon" id="icon-${monthKey}">â–¼</span>
                <strong>${monthLabel}</strong>
                <span class="month-count">(${monthData.length}ì¼)</span>
              </div>
            </td>
            <td data-label="ë°©ë¬¸ì" class="table-value">${totalVisitors.toLocaleString()}ëª…</td>
            <td data-label="í˜ì´ì§€ë·°" class="table-value">${totalPageviews.toLocaleString()}íšŒ</td>
            <td data-label="í‰ê·  ì²´ë¥˜">${formatDuration(avgDuration)}</td>
            <td data-label="ì´íƒˆë¥ ">${Math.round(avgBounce * 100)}%</td>
          </tr>
        `;

        monthData.forEach(row => {
          html += `
            <tr class="month-detail-row" data-parent="${monthKey}">
              <td data-label="ë‚ ì§œ">${formatHistoryDate(row.date)}</td>
              <td data-label="ë°©ë¬¸ì" class="table-value">${(row.visitors || 0).toLocaleString()}ëª…</td>
              <td data-label="í˜ì´ì§€ë·°" class="table-value">${(row.pageviews || 0).toLocaleString()}íšŒ</td>
              <td data-label="í‰ê·  ì²´ë¥˜">${formatDuration(row.avg_duration || 0)}</td>
              <td data-label="ì´íƒˆë¥ ">${Math.round((row.bounce_rate || 0) * 100)}%</td>
            </tr>
          `;
        });
      });

      tbody.innerHTML = html;
      renderPagination(totalItems, totalPages, startIndex, endIndex);
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ UI
    function renderPagination(totalItems, totalPages, startIndex, endIndex) {
      const infoEl = document.getElementById('pagination-info');
      const controlsEl = document.getElementById('pagination-controls');

      infoEl.textContent = `ì´ ${totalItems.toLocaleString()}ê°œ ì¤‘ ${startIndex + 1}-${endIndex}`;

      let html = `<button class="pagination-btn nav-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>â—€ ì´ì „</button>`;

      const maxPages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
      let endPage = Math.min(totalPages, startPage + maxPages - 1);
      if (endPage - startPage < maxPages - 1) startPage = Math.max(1, endPage - maxPages + 1);

      if (startPage > 1) {
        html += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) html += `<span style="padding:0 4px;color:var(--neutral-400)">...</span>`;
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += `<span style="padding:0 4px;color:var(--neutral-400)">...</span>`;
        html += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
      }

      html += `<button class="pagination-btn nav-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ë‹¤ìŒ â–¶</button>`;

      controlsEl.innerHTML = html;
    }

    function goToPage(page) {
      const totalPages = Math.ceil(allHistoryData.length / pageSize);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderHistoryTable(allHistoryData);
    }

    function changePageSize(newSize) {
      pageSize = parseInt(newSize);
      currentPage = 1;
      renderHistoryTable(allHistoryData);
    }

    function toggleMonthGroup(monthKey) {
      const detailRows = document.querySelectorAll(`tr[data-parent="${monthKey}"]`);
      const icon = document.getElementById(`icon-${monthKey}`);
      const isHidden = detailRows[0]?.style.display === 'none';

      detailRows.forEach(row => row.style.display = isHidden ? '' : 'none');
      if (icon) icon.textContent = isHidden ? 'â–¼' : 'â–¶';
    }

    // íˆìŠ¤í† ë¦¬ ì°¨íŠ¸
    function renderHistoryChart(data) {
      const ctx = document.getElementById('historyChart').getContext('2d');

      if (historyChart) historyChart.destroy();

      if (!data || data.length === 0) {
        historyChart = new Chart(ctx, {
          type: 'line',
          data: { labels: [], datasets: [] },
          options: { responsive: true, maintainAspectRatio: false }
        });
        return;
      }

      const sortedData = [...data].sort((a, b) => a.date.localeCompare(b.date));
      const labels = sortedData.map(d => formatHistoryChartDate(d.date));
      const visitors = sortedData.map(d => d.visitors || 0);
      const pageviews = sortedData.map(d => d.pageviews || 0);

      historyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'ë°©ë¬¸ì',
              data: visitors,
              borderColor: '#0066CC',
              backgroundColor: 'rgba(0, 102, 204, 0.1)',
              fill: true,
              tension: 0.3,
              borderWidth: 2,
              pointRadius: filterDays <= 14 ? 4 : 2,
              pointHoverRadius: 6
            },
            {
              label: 'í˜ì´ì§€ë·°',
              data: pageviews,
              borderColor: '#10B981',
              backgroundColor: 'transparent',
              tension: 0.3,
              borderWidth: 2,
              pointRadius: filterDays <= 14 ? 4 : 2,
              pointHoverRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              align: 'end',
              labels: { boxWidth: 12, padding: 16, font: { size: 11 } }
            },
            tooltip: {
              backgroundColor: 'white',
              titleColor: '#1F2937',
              bodyColor: '#4B5563',
              borderColor: '#E5E7EB',
              borderWidth: 1,
              padding: 12
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { font: { size: 10 }, maxTicksLimit: filterDays <= 14 ? 7 : 10 }
            },
            y: {
              beginAtZero: true,
              grid: { color: '#F3F4F6' },
              ticks: { font: { size: 11 } }
            }
          }
        }
      });
    }

    // ë§ˆì§€ë§‰ ìˆ˜ì§‘ ì‹œì 
    function updateLastSyncTime(data) {
      const el = document.getElementById('lastSyncTime');
      if (!data || data.length === 0) {
        el.textContent = 'ë§ˆì§€ë§‰ ìˆ˜ì§‘: ë°ì´í„° ì—†ìŒ';
        return;
      }
      const sortedData = [...data].sort((a, b) => b.date.localeCompare(a.date));
      const latestDate = sortedData[0].date;
      const [year, month, day] = latestDate.split('-');
      el.textContent = `ë§ˆì§€ë§‰ ìˆ˜ì§‘: ${year.slice(2)}.${month}.${day} 01:00 (KST) â€¢ ë§¤ì¼ ìë™ ìˆ˜ì§‘`;
    }

    // ë¶„ì„ í‰ê°€ ìƒì„±
    function generateAnalysisSummary(data) {
      const container = document.getElementById('analysis-content');

      if (!data || data.length === 0) {
        container.innerHTML = `
          <div class="analysis-item neutral">
            <div class="analysis-label">ë°ì´í„° ì—†ìŒ</div>
            <div class="analysis-text">ì„ íƒí•œ ê¸°ê°„ì— ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
          </div>
        `;
        return;
      }

      const totalVisitors = data.reduce((sum, d) => sum + (d.visitors || 0), 0);
      const totalPageviews = data.reduce((sum, d) => sum + (d.pageviews || 0), 0);
      const avgDuration = data.reduce((sum, d) => sum + (d.avg_duration || 0), 0) / data.length;
      const avgBounce = data.reduce((sum, d) => sum + (d.bounce_rate || 0), 0) / data.length;
      const avgVisitorsPerDay = totalVisitors / data.length;

      // ì¶”ì„¸ ë¶„ì„
      const halfLen = Math.floor(data.length / 2);
      const sortedData = [...data].sort((a, b) => a.date.localeCompare(b.date));
      const firstHalf = sortedData.slice(0, halfLen);
      const secondHalf = sortedData.slice(halfLen);
      const firstHalfAvg = firstHalf.reduce((sum, d) => sum + (d.visitors || 0), 0) / (firstHalf.length || 1);
      const secondHalfAvg = secondHalf.reduce((sum, d) => sum + (d.visitors || 0), 0) / (secondHalf.length || 1);
      const trendChange = firstHalfAvg > 0 ? ((secondHalfAvg - firstHalfAvg) / firstHalfAvg * 100).toFixed(1) : 0;

      const analyses = [];

      // 1. ì´ ë°©ë¬¸ì
      const visitorStatus = totalVisitors > 100 ? 'positive' : totalVisitors > 30 ? 'neutral' : 'negative';
      analyses.push({
        status: visitorStatus,
        label: 'ğŸ“Š ì´ ë°©ë¬¸ì',
        text: `ì„ íƒ ê¸°ê°„ ë™ì•ˆ ì´ ${totalVisitors.toLocaleString()}ëª…ì´ ë°©ë¬¸í–ˆìŠµë‹ˆë‹¤. ì¼ í‰ê·  ${avgVisitorsPerDay.toFixed(1)}ëª…ì…ë‹ˆë‹¤.`
      });

      // 2. ì¶”ì„¸
      if (data.length >= 4) {
        const trendStatus = parseFloat(trendChange) > 10 ? 'positive' : parseFloat(trendChange) < -10 ? 'negative' : 'neutral';
        const trendText = parseFloat(trendChange) > 0
          ? `ë°©ë¬¸ìê°€ ${trendChange}% ì¦ê°€í•˜ëŠ” ìƒìŠ¹ ì¶”ì„¸ì…ë‹ˆë‹¤.`
          : parseFloat(trendChange) < 0
          ? `ë°©ë¬¸ìê°€ ${Math.abs(trendChange)}% ê°ì†Œí•˜ëŠ” í•˜ë½ ì¶”ì„¸ì…ë‹ˆë‹¤.`
          : 'ë°©ë¬¸ì ìˆ˜ê°€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.';
        analyses.push({ status: trendStatus, label: 'ğŸ“ˆ ì¶”ì„¸ ë¶„ì„', text: `ê¸°ê°„ ì „ë°˜ë¶€ ëŒ€ë¹„ í›„ë°˜ë¶€ ê¸°ì¤€, ${trendText}` });
      }

      // 3. ì²´ë¥˜ì‹œê°„
      const durationMins = Math.floor(avgDuration / 60);
      const durationSecs = Math.round(avgDuration % 60);
      const durationStatus = avgDuration > 180 ? 'positive' : avgDuration > 60 ? 'neutral' : 'negative';
      const durationAdvice = avgDuration > 180 ? 'ì½˜í…ì¸ ì— ëŒ€í•œ ê´€ì‹¬ë„ê°€ ë†’ìŠµë‹ˆë‹¤.' : avgDuration > 60 ? 'ì ì • ìˆ˜ì¤€ì˜ ì²´ë¥˜ì‹œê°„ì…ë‹ˆë‹¤.' : 'ì½˜í…ì¸  ê°œì„ ìœ¼ë¡œ ì²´ë¥˜ì‹œê°„ì„ ëŠ˜ë ¤ë³´ì„¸ìš”.';
      analyses.push({ status: durationStatus, label: 'â±ï¸ ì²´ë¥˜ì‹œê°„', text: `í‰ê·  ì²´ë¥˜ì‹œê°„ ${durationMins}ë¶„ ${durationSecs}ì´ˆ. ${durationAdvice}` });

      // 4. ì´íƒˆë¥ 
      const bouncePercent = Math.round(avgBounce * 100);
      const bounceStatus = bouncePercent < 50 ? 'positive' : bouncePercent < 70 ? 'neutral' : 'negative';
      const bounceAdvice = bouncePercent < 50 ? 'ìš°ìˆ˜í•œ ì´íƒˆë¥ ì…ë‹ˆë‹¤.' : bouncePercent < 70 ? 'í‰ê· ì ì¸ ì´íƒˆë¥ ì…ë‹ˆë‹¤.' : 'ëœë”© í˜ì´ì§€ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.';
      analyses.push({ status: bounceStatus, label: 'ğŸšª ì´íƒˆë¥ ', text: `í‰ê·  ì´íƒˆë¥  ${bouncePercent}%. ${bounceAdvice}` });

      // 5. í˜ì´ì§€ë·°
      const pagesPerVisit = totalVisitors > 0 ? (totalPageviews / totalVisitors).toFixed(1) : 0;
      const pvStatus = pagesPerVisit > 3 ? 'positive' : pagesPerVisit > 1.5 ? 'neutral' : 'negative';
      analyses.push({ status: pvStatus, label: 'ğŸ“„ í˜ì´ì§€ë·°', text: `ë°©ë¬¸ìë‹¹ í‰ê·  ${pagesPerVisit}ê°œ í˜ì´ì§€ ì¡°íšŒ. ì´ ${totalPageviews.toLocaleString()}íšŒ í˜ì´ì§€ë·°.` });

      container.innerHTML = analyses.map(a => `
        <div class="analysis-item ${a.status}">
          <div class="analysis-label">${a.label}</div>
          <div class="analysis-text">${a.text}</div>
        </div>
      `).join('');
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    function formatDuration(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.round(seconds % 60);
      return `${mins}ë¶„ ${secs}ì´ˆ`;
    }

    function formatChartDate(dateStr) {
      if (!dateStr) return '';
      const month = dateStr.substring(5, 7);
      const day = dateStr.substring(8, 10);
      return `${parseInt(month)}/${parseInt(day)}`;
    }

    function formatHistoryDate(dateStr) {
      if (!dateStr) return '-';
      const year = dateStr.substring(0, 4);
      const month = dateStr.substring(5, 7);
      const day = dateStr.substring(8, 10);
      const date = new Date(year, parseInt(month) - 1, day);
      const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      return `${month}.${day} (${dayNames[date.getDay()]})`;
    }

    function formatHistoryChartDate(dateStr) {
      if (!dateStr) return '';
      const month = dateStr.substring(5, 7);
      const day = dateStr.substring(8, 10);
      return `${parseInt(month)}/${parseInt(day)}`;
    }

    function translatePage(path) {
      const map = {
        '/': 'ë©”ì¸ í˜ì´ì§€',
        '/index.html': 'ë©”ì¸ í˜ì´ì§€',
        '/about.html': 'íšŒì‚¬ ì†Œê°œ',
        '/contact.html': 'ë¬¸ì˜í•˜ê¸°',
        '/service.html': 'ì„œë¹„ìŠ¤',
        '/post': 'ê²Œì‹œê¸€'
      };
      return map[path] || path;
    }

    function showLoading() {
      ['stat-visitors', 'stat-pageviews', 'stat-duration', 'stat-bounce'].forEach(id => {
        document.getElementById(id).textContent = '-';
      });
      ['stat-visitors-change', 'stat-pageviews-change', 'stat-duration-change', 'stat-bounce-change'].forEach(id => {
        document.getElementById(id).textContent = 'ë¡œë”© ì¤‘...';
        document.getElementById(id).className = 'stat-change';
      });
    }

    function showError(message) {
      document.getElementById('period-display').textContent = 'ì˜¤ë¥˜ ë°œìƒ';
      ['stat-visitors', 'stat-pageviews', 'stat-duration', 'stat-bounce'].forEach(id => {
        document.getElementById(id).textContent = '-';
      });
      ['stat-visitors-change', 'stat-pageviews-change', 'stat-duration-change', 'stat-bounce-change'].forEach(id => {
        document.getElementById(id).textContent = message;
        document.getElementById(id).className = 'stat-change negative';
      });
    }

    function refreshData() {
      const btn = document.querySelector('.refresh-btn');
      btn.classList.add('loading');
      loadAllDataWithFilter().finally(() => {
        btn.classList.remove('loading');
      });
    }
  </script>
</body>
</html>
